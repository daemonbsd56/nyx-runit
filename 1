#!/bin/sh
# system one time tasks

[ -r /etc/runit/runit.conf ] && . /etc/runit/runit.conf

PATH=/sbin:/bin:/usr/sbin:/usr/bin

msg() {
    echo -e "\e[0;32m*\e[0m $@"
}

emergency_shell() {
    echo
    echo "Cannot continue due to errors above, starting emergency shell."
    echo "When ready type exit to continue booting."
    /bin/sh -l
}

welcome() {
	echo
	echo -e "Welcome to \e[0;32m$1\e[0m!"
	echo
}

welcome "GNU/Linux"

msg "Mounting pseudo-filesystems..."
mountpoint -q /run  || mount /run
mountpoint -q /proc || mount -o nosuid,noexec,nodev /proc
mountpoint -q /sys  || mount -o nosuid,noexec,nodev /sys
mountpoint -q /dev  || mount -o mode=0755,nosuid /dev
mkdir -p /run/lock /run/shm /dev/pts
chmod 1777 /run/shm /run/lock
ln -sfn /run/shm /dev/shm

if [[ -f /etc/runit/modules ]] && [[ "$(egrep -v '^($|#)' /etc/runit/modules)" ]]; then
	msg "Loading modules..."
	while read module args; do
		case "$module" in
			""|"#"*) continue ;;
		esac
		modprobe ${module}
	done < /etc/runit/modules
fi

msg "Bringing up the loopback interface..."
ip addr add 127.0.0.1/8 label lo dev lo
ip link set lo up

if [ -f /etc/hostname ]; then
	HOSTNAME=$(cat /etc/hostname)
else
	HOSTNAME="nyx"
	echo $HOSTNAME > /etc/hostname
fi
msg "Set hostname to '$HOSTNAME'..."
hostname $HOSTNAME

msg "Populating /dev with device nodes... "
udevd --daemon
udevadm trigger --action=add    --type=subsystems
udevadm trigger --action=add    --type=devices
udevadm trigger --action=change --type=devices
udevadm settle
if [ -x vgchange ]; then vgchange -a y >/dev/null; fi

msg "Activating all swap files/partitions..."
swapon -a

[ -f /fastboot ] && FASTBOOT=1
[ -f /forcefsck ] && FORCEFSCK="-f"
if [ -z "$FASTBOOT" ]; then
	msg "Checking file systems..."
	fsck $FORCEFSCK -a -A -C -T >/dev/null
	if [ $? -gt 1 ]; then
        emergency_shell
    fi
fi

msg "Remounting root file system in read-write mode..."
mount --options remount,rw / >/dev/null  || emergency_shell

rm -f /fastboot /forcefsck

msg "Mounting remaining file systems..."
mount --all --test-opts no_netdev >/dev/null  || emergency_shell

if [ "$SKIPTMPCLEAN" = "" ]; then
	msg "Cleaning /tmp directory..." 
	(cd /tmp &&
	find . -xdev -mindepth 1 ! -name lost+found -delete
	mkdir -m 1777 /tmp/.ICE-unix
	mkdir -m 1777 /tmp/.X11-unix)
fi

> /var/run/utmp

if grep -q '^utmp:' /etc/group ; then
	chmod 664 /var/run/utmp
	chgrp utmp /var/run/utmp
fi

if [ -f "/etc/sysctl.conf" ]; then
	msg "Setting kernel runtime parameters..."
	sysctl -q -p
fi

msg "Setting up Linux console..."
[ -z "$FONT" ] || setfont $FONT
[ -z "$KEYMAP" ] || loadkeys $KEYMAP >/dev/null 2>&1

if [ -n "$HARDWARECLOCK" ]; then
    case "$HARDWARECLOCK" in
		UTC)       CLOCKPARAMS="--utc" ;;
		localtime) CLOCKPARAMS="--localtime" ;;
	esac
    msg "Setting up RTC to '${HARDWARECLOCK}'..."
	hwclock --hctosys "$CLOCKPARAMS"
fi

if [ -f "/var/lib/random-seed" ]; then
  msg "Initializing random number generator..."
  cat /var/lib/random-seed >/dev/urandom
  rm -f /var/lib/random-seed
fi

dmesg >/var/log/dmesg.log

msg "Initialization complete..."

touch /etc/runit/stopit
chmod 0 /etc/runit/stopit
